
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ğŸ” Fonction utilitaire pour vÃ©rifier si l'utilisateur est admin
    function isAdmin() {
      // VÃ©rifie si l'utilisateur authentifiÃ© a le rÃ´le 'admin' dans son document utilisateur.
      // C'est une mÃ©thode sÃ©curisÃ©e et scalable pour gÃ©rer les permissions.
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // ğŸ”’ Par dÃ©faut, interdire tout accÃ¨s. RÃ¨gle de sÃ©curitÃ© fondamentale.
    match /{document=**} {
      allow read, write: if false;
    }
    
    // âœ… Autoriser la LECTURE de la LISTE des collections Ã  la racine.
    // Essentiel pour que l'application puisse dÃ©couvrir les collections comme 'shoes', 'categories', etc.
    // sans Ãªtre bloquÃ©e par la rÃ¨gle de sÃ©curitÃ© par dÃ©faut.
    match /databases/{database}/documents {
      allow list: if request.auth == null || request.auth != null; // Autorise tout le monde, authentifiÃ© ou non
    }

    // ğŸ‘¤ RÃ¨gles pour la collection 'users'
    match /users/{userId} {
      // Un utilisateur ne peut lire et Ã©crire que son propre document.
      allow read, write: if request.auth.uid == userId;
      // Un admin peut lire le document de n'importe quel utilisateur (utile pour le support).
      allow get: if isAdmin();
    }

    // ğŸ‘Ÿ Produits : lecture publique, modification rÃ©servÃ©e aux admins
    match /shoes/{shoeId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    // ğŸ—‚ï¸ CatÃ©gories : lecture publique, modification rÃ©servÃ©e aux admins
    match /categories/{categoryId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    // ğŸ¯ Collections : lecture publique, modification rÃ©servÃ©e aux admins
    match /collections/{collectionId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    // ğŸ§¾ Commandes :
    match /orders/{orderId} {
      // Un utilisateur connectÃ© peut crÃ©er une commande.
      allow create: if request.auth != null;
      // Seul l'admin peut lire, mettre Ã  jour ou supprimer des commandes.
      // La lecture est restreinte pour que les utilisateurs ne voient pas les commandes des autres.
      // Le suivi de commande se fait via une action serveur sÃ©curisÃ©e (getOrdersForUser).
      allow read, update, delete: if isAdmin();
      // Un utilisateur peut lire ses propres commandes.
      allow list: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    // ğŸŸï¸ Codes promo : accÃ¨s rÃ©servÃ© aux admins
    match /promoCodes/{promoCodeId} {
      allow read, write: if isAdmin();
    }
  }
}
